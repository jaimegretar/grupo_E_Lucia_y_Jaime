---
title: "Suicidio y climas extremos"
author: Jaime Miguel y Lucía Toimil
date: Sys.Date()
output: 
  html_document:
    toc: true
    toc_float: true
editor_options: 
  markdown: 
    wrap: sentence
---

# INTRODUCCIÓN

**Islandia** se caracteriza por su clima frio y extremo, además de por la escasa cantidad de luz durante gran parte del año.
En cambio, **Arizona** tiene un clima cálido y seco, con abundante luz solar la mayor parte del tiempo.
Estos dos lugares, con climas tan extremos y distintos, permiten evaluar de manera comparativa como diferentes condiciones climáticas pueden influir en la **salud mental** y en la tasa de **suicidios**.

# OBJETIVOS

## Objetivo general

Analizar la posible relación entre las condiciones climáticas y la salud mental, evaluando como el clima podría influir en la tasa de suicidios en Islandia y Arizona.

# Objetivos especificos

-   Comparar la tasa de suicidios en Islandia y Arizona en relación con sus caracteristicas climáticas.
-   Comparar las tasas de suicidios entre hombres y mujeres en ambos lugares
-   Estudiar el impacto de episodios extremos de temperatura con suicidios posteriores a ellos.
-   Analizar efectos estacionales en las tasas de suicidios.

# METODOLOGÍA

## 1.1. Carga de paquetes:

A continuación se encuentran los paquetes empleados para cargar y trabajar con los datos del seminario.

```{r setup, message=FALSE, warning=FALSE}

library(tidyverse)
library(readr)
library(lubridate)
library(rjstat)     
library(jsonlite)
library(rjson)
library(tidyjson)
library(plotly)
library(dplyr)
```

## 1.2. Obtención de datos de temperatura y suicidio (Islandia y Arizona)

Para la obtencion de datos hemos realizado diversas busquedas en bases de datos y consultas a una API.
El siguiente código Python define las funciones necesarias para consultar la API de Veðurstofa Íslands (api.vedur.is), buscar la estación por nombre ("Reykjav"), solicitar la temperatura media diaria (t) y guardar el resultado en archivos CSV y JSON.
La consulta se ha realizado con ayuda de la IA.

```{python, eval=FALSE}
import os, sys
sys.path.append(os.path.join(os.getcwd(), "API")) #Para buscar la carpeta con la API.

from islandiaTemp import find_station_id_by_name_hint, get_daily_t, get_monthly_t, save

CITY_HINT = "Reykjav"
START = "1980-01-01"
END = "2023-12-31"
OUT_PREFIX = "temperatura_reykjavik_2018_2023" #Guardar el .json para luego usarlo.

station_id = find_station_id_by_name_hint(CITY_HINT)
daily = get_daily_t(station_id, START, END)

if not daily.empty:
    save(daily, OUT_PREFIX)
else:
    monthly = get_monthly_t(station_id, START, END)
    save(monthly, OUT_PREFIX + "_mensual")
```

### 1.2.1 Importacion de datos de temperatura:

#### Arizona:

Obtenemos los datos de temperatura de Arizona, desde un archivo .csv y desde un archivo .json:

```{r}
# Importacion datos temperatura Arizona .json
Arizona_temp_json <- fromJSON(file = "INPUT/DATA/Arizona/Temperatura/data.json")
Arizona_temp_json %>%
  spread_all() #%>%
  #View()

# Importacion .csv datos temperatura Arizona
Arizona_temp_csv <- read_delim(file="INPUT/DATA/Arizona/Temperatura/data.csv", delim = ",")
#View(Arizona_temp_csv)
```

Aunque disponemos de los datos de temperatura en ambos formatos, optaremos por utilizar el archivo .csv, ya que es más sencillo de manejar y el formato .json nos ha generado problemas.

#### Islandia:

Importacion de los datos de temperatura de Islandia (Reikiavik) en .json, en el periodo del 2018-2023:

```{r}
# Importacion datos temperatura Islandia .json
Islandia_temp_json <- fromJSON(file = "INPUT/DATA/Islandia/Temperatura/temperatura_reykjavik_2018_2023.json")
Islandia_temp_json %>%
  spread_all() #%>%
  #View()
```

### 1.2.2. Importacion de datos de suicidios:

#### Arizona:

Importamos los datos de suicidios de Arizona (relacionados con salud mental) desde un archivo CSV.
Se utilizo la ayuda de la IA para poder importar los archivoa correctamente ya que contenia los datos encapsulados con dobles comillas y más caracteres que dificultaban su procesamiento.
Importamos primeramente un csv que contiene información sobre suicidios clasificados por rangos de edad, sexo y regiones de Arizona.
Con `delim = "\n"` indicamos que se lea linea por linea sin separar todavia por comas.
`col_names = FALSE` especifica que el archivo no tiene encabezados y `show_col_types = FALSE` evita que se muestre la información de columnas sin leer.
El resultado es un data frame "datos" de una sola columna donde cada fila es toda una linea del csv.

```{r}
datos <- read_delim(
  "INPUT/DATA/Arizona/Salud/Arizona_condado_edad.csv",
  delim = "\n",  # Leer línea por línea
  col_names = FALSE,
  show_col_types = FALSE
)
#View(datos)
```

A continuación, con `mutate(linea = .[[1]])` creamos una nueva columna llamada linea que contiene una copia de toda la primera columna del data frame original, y se toma la primera columna de datos.
Obteniendo asi un data frame con 2 columnas: la original y "linea" que tiene la misma información.
Utilizamos `separate()` para dividir la columna "linea" en varias columnas nuevas: + `into =c(...)` define los nombres de las nuevas columnas + `sep = ',(?=(?:[^"]*"[^"]*")*[^"]*$)'` se usa para separar las columnas por comas que no esten dentro de las dobles comillas. + `extra = "merge"` se ussa para que si hay mas columnas de las esperadas, todo eso se junta en una ultima columna extra para evitar que de error a la hora de ejecutarlo. Luego, con `mutate(across(everything(), ~str_replace_all(., '"', '')))` se aplica la misma función a todas las columnas y elimina las dobles comillas.
A continuación, con `select(-1)` se elimina la primera columna original del data frame que contenia la linea completa, y con `slice(-1)` se elimina la primera fila que contenia los encabezados del csv y ya no son necesarios.
Por último, se convierte todas las columnas de años de tipo texto a numérico con `across(`2015`:`2023`, ~as.numeric(.))`.
El resultado es un data frame "Arizona" que tiene columnas separadas para cada tipo de dato limpias de dobles comillas.

```{r}
# Separar y limpiar
Arizona <- datos %>%
  mutate(linea = .[[1]]) %>%
  separate(linea,
           into = c("County", "Sex", "Age_Group", "2015", "2016", 
                    "2017", "2018", "2019", "2020", "2021", "2022", "2023"),
           sep = ',(?=(?:[^"]*"[^"]*")*[^"]*$)',  # Separar por comas fuera de comillas
           extra = "merge") %>%
  mutate(across(everything(), ~str_replace_all(., '"', ''))) %>%  # Quitar comillas
  select(-1) %>%  # Eliminar la primera columna original
  slice(-1)  # Eliminar la fila de encabezados si quedó duplicada

# Convertir años a numérico
Arizona <- Arizona %>%
  mutate(across(`2015`:`2023`, ~as.numeric(.)))

# Ver resultado
#View(Arizona)
```

Además, se importo otro archivo .csv para complementar los datos de suicidios de Arizona desde el 2018-2023.
Se importa un csv que contiene datos de suicidios y otras causas de muerte, con `header = TRUE` se indica que la primera fila contiene los nombres de las columnas y con `stringsAsFactors = FALSE` se evita que las columnas de texto se conviertan en factores, se mantienen como strings.
El resultado sería un data frame "datos2" que contiene en la primera fila los nombres de las columnas y en las demas los datos respectivos al csv.

```{r}
# Importacion .csv datos suicidios de Arizona (relacionado con salud mental)
datos2 <- read.csv("INPUT/DATA/Arizona/Salud/reports-data-export.csv",
                   header = TRUE,
                   stringsAsFactors = FALSE)

#View(datos2)
```

A continuación, se utiliza `mutate(linea = .[[1]]) %>%` y `mutate(across(everything(), ~str_replace_all(., '"', ''))) %>%` al igual que en csv anterior.

```{r}
# Usar una expresión regular más sofisticada para separar respetando las comillas
datos_separados <- datos2 %>%
  mutate(linea = .[[1]]) %>%
  separate(linea,
           into = c("Intent", "Year", "Age_Group", "Sex", "Deaths", 
                    "Population", "Crude_Rate", "Age_Adjusted_Rate", 
                    "Years_Potential_Life_Lost"),
           sep = ',(?=(?:[^"]*"[^"]*")*[^"]*$)',  # Separar por comas fuera de comillas
           extra = "merge") %>%
  mutate(across(everything(), ~str_replace_all(., '"', ''))) %>%  # Quitar comillas
  select(-1)  # Eliminar la primera columna original

# Ver resultado
#View(datos_separados)
```

#### Islandia:

Importamos los datos de suicidios de Islandia desde un archivo JSON con formato JSON-stat.

```{r}
# Importacion .json datos suicidios de Islandia (relacionado con salud mental)
Islandia_suicidio_json <- fromJSONstat("INPUT/DATA/Islandia/Salud/suicidios_islandia.json")
df <- as.data.frame(Islandia_suicidio_json)
#View(df)
```

### 1.2.3. Importacion de datos del PIB per capita.

Además de los datos de temperatura y suicidios, se han incorporado datos de PIB per cápita debido a su fácil accesibilidad y relevancia socioeconómica.
El objetivo de incluir esta variable es explorar si el nivel de riqueza media por habitante podría estar relacionado, directa o indirectamente, con las variaciones en las tasas de suicidio, y poder visualizarlo con ambos climas tan diferentes.
#### Arizona:

```{r}
pib_arizona <- read.csv("INPUT/DATA/Arizona/pib/pib_arizona.csv",
                        header = TRUE,
                        stringsAsFactors = FALSE)
```

#### Islandia:

```{r}
pib_islandia <- read.csv("INPUT/DATA/Islandia/pib/pib_islandia.csv",
                   header = TRUE,
                   stringsAsFactors = FALSE)
```

## 1.3. Limpieza y preparación de datos

Los archivos originales contienen una gran cantidad de información que no resulta relevante para los objetivos de este seminario.
Por ello, se ha llevado a cabo un proceso de limpieza y filtrado para conservar únicamente aquellas variables relacionadas con las tasas de suicidio y la temperatura.

Asimismo, es importante destacar que no todas las fuentes presentan datos a partir del mismo año.
Aunque el periodo de referencia del estudio comienza en 1980, algunos conjuntos de datos no cubren todo este intervalo.
En particular, los datos de suicidios de Arizona solo están disponibles a partir de 2015, a diferencia de Islandia, cuyos registros se remontan a 1980.
Ante esta limitación, se ha optado por adaptar el análisis a la disponibilidad real de los datos, aplicando estrategias diferenciadas según el caso para garantizar la coherencia y validez de los resultados.

### 1.3.1.Limpieza y preparación de datos de temperatura

#### Arizona:

Filtramos del Arizona_temp_csv los datos de temperatura media entre los años 1980 y 2023, y creamos nuevas columnas para el año, mes y convertimos la temperatura de Fº a Cº.

```{r}
Arizona_temp_filtrado <- Arizona_temp_csv %>%
  filter(Date >= 201801 & Date <= 202312) %>%
  mutate(
    Year = Date %/% 100,
    Month = Date %% 100,
    Value = round((Value - 32) * 5/9, 1)
  ) %>%
  select(Year, Month, Value)

#View(Arizona_temp_filtrado)
```

#### Islandia:

En el caso de Islandia , los datos ya están filtrados en el archivo JSON, por lo que no es necesario realizar un filtrado adicional.
### 1.3.2.Limpieza y preparación de datos de suicidios \#### Arizona: Del primer csv eliminamos los NA y los convertimos a 0.

```{r}
#Convertir los NA a 0
Arizona_2015_2023 <- Arizona %>%
  mutate(across(`2015`:`2023`, ~replace_na(., 0)))
#View(Arizona_2015_2023)
```

Filtramos los datos de suicidios de Arizona pero solo del segundo csv ya que el primero es por regiones y ya vienen especificados los años.
Primeramente hay que convertir los datos a tipo numer ico para poder trabajar con ellos.

```{r}
# Limpieza de datos - convertir a numérico
arizona_csv <- datos_separados %>%
  mutate(
    Year = as.numeric(Year),
    Deaths = as.numeric(gsub("[^0-9]", "", Deaths)),
    Population = as.numeric(gsub(",", "", Population)),  # Solo quitar comas
    Crude_Rate = as.numeric(gsub("[*]", "", Crude_Rate)),
    Age_Adjusted_Rate = as.numeric(gsub("[*]", "", Age_Adjusted_Rate)),
    Years_Potential_Life_Lost = as.numeric(gsub(",", "", Years_Potential_Life_Lost))
  )

# Ver resumen
#View(arizona_csv)
```

Posteriormente, filtramos solo los suicidios entre los años 2018 y 2023.

```{r}
# Filtrar solo suicidios
arizona_suicidios <- arizona_csv %>%
  filter(Intent == "Suicide")

# Ver el resultado
#View(arizona_suicidios)
```

#### Islandia:

Se han filtrado los datos de suicidio de Islandia para el periodo 1981–2023.

```{r}
suicidios_Islandia <- df %>%
  mutate(Year = as.numeric(Year)) %>%
  filter(Year >= 1981 & Year <= 2023)

# Contar observaciones por año
suicidios_Islandia %>%
  count(Year)
#View(suicidios_Islandia)
```

### 1.3.3.Limpieza y preparación de datos de PIB.

#### Islandia:

Hacemos un left_join con el PIB per cápita usando el año como clave, de forma que en islandia_temp_pib_anual tenemos, para cada año, la temperatura media anual y el PIB per cápita ordenados cronológicamente.

```{r}
islandia_1981 <- islandia_temp_anual %>%
  filter(Year>=1981)

islandia_temp_pib_anual <- islandia_1981 %>%
  left_join(pib_islandia, by = c("Year" = "year")) %>%
  arrange(Year)
```

#### Arizona:

Se calcula la temperatura media anual de Arizona desde el año 2000, agrupando por año y promediando la temperatura.
Después, se hace un left_join con el PIB per cápita usando el año como clave, de manera que Arizona_temp_pib_anual contiene, para cada año, la temperatura media anual y el PIB per cápita ordenados cronológicamente.

```{r}
Arizona_temp_anual <- Arizona_temp_filtrado %>%
  filter(Year >= 2000) %>%                 
  group_by(Year) %>%
  summarise(
    temp_media_anual = mean(Value, na.rm = TRUE),
  )
#view(Arizona_temp_anual)

Arizona_temp_pib_anual <- Arizona_temp_anual %>%
  left_join(pib_arizona, by = c("Year" = "year")) %>%
  arrange(Year)

#View(Arizona_temp_pib_anual)
```

# GRÁFICAS

A continuación se muestran las gráficas obtenidas a partir de los datos importados y filtrados.
## 2.1.
Gráficas individuales Primeramente se obtuveron gráficas individuales para cada lugar con respecto a la variación de temperatura y suicidios.
### 2.1.1.Gráficas de suicidios.
Se generaron gráficas que muestran la tasa de suicidios por año enfrentando hombres (azul) y mujeres (rojo).

#### Arizona:

```{r}
arizona_suic_sexo <- arizona_suicidios %>%
  filter(!is.na(Deaths), !is.na(Year)) %>%
  group_by(Year, Sex) %>%
  summarise(Total_Deaths = sum(Deaths, na.rm = TRUE))

# Crear gráfico
graf_suicHF_ariz <- ggplot(arizona_suic_sexo, aes(x = Year, y = Total_Deaths, color = Sex, group = Sex)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Males" = "#3498db", "Females" = "#e74c3c"),
                     labels = c("Females" = "Mujeres", "Males" = "Hombres")) +
  labs(title = "Suicidios por Sexo en Arizona",
       subtitle = "2018-2023",
       x = "Año",
       y = "Número de suicidios",
       color = "Sexo") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16),
        panel.grid.minor = element_blank(),
        legend.position = "top")

print(graf_suicHF_ariz)
```

#### Islandia:

```{r}
df_clean <- suicidios_Islandia

df_sexo <- suicidios_Islandia %>%
  filter(Age == "Total", Sex != "Total")

graf_suicHF_isl <- ggplot(df_sexo, aes(x = Year, y = value, color = Sex, group = Sex)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(values = c("Males" = "#3498db", "Females" = "#e74c3c"),
                     labels = c("Females" = "Mujeres", "Males" = "Hombres")) +
  labs(title = "Suicidios por Sexo en Islandia",
       x = "Año",
       y = "Número de suicidios",
       color = "Sexo") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold", size = 16),
        panel.grid.minor = element_blank(),
        legend.position = "top")

print(graf_suicHF_isl)
```

### 2.1.2. Gráficas de temperatura

Se generaron gráficas que muestran la media de las temperaturas (medida en grados Celsius) por sepearandolas por estaciones.
#### Arizona:

```{r}
# Gráfica de temperatura en Arizona
df_temp_arizona <- Arizona_temp_filtrado %>%
  mutate(
    # Crear fecha para extraer mes y estación
    fecha = as.Date(paste(Year, Month, "01", sep = "-")),
    mes = month(fecha, label = TRUE, abbr = FALSE),
    estacion = case_when(
      Month %in% c(12, 1, 2) ~ "Invierno",
      Month %in% c(3, 4, 5) ~ "Primavera",
      Month %in% c(6, 7, 8) ~ "Verano",
      Month %in% c(9, 10, 11) ~ "Otoño"
    )
  )

# Resumen por año y estación
df_resumen_arizona <- df_temp_arizona %>%
  group_by(Year, estacion) %>%
  summarise(
    temp_media = mean(Value, na.rm = TRUE),
    temp_max = max(Value, na.rm = TRUE),
    temp_min = min(Value, na.rm = TRUE)
  ) %>%
  mutate(estacion = factor(estacion, levels = c("Invierno", "Primavera", "Verano", "Otoño")))

# Gráfico de temperatura
graf_temp_arizona <- ggplot(df_resumen_arizona, aes(x = as.factor(Year), y = temp_media, fill = estacion)) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(
    values = c("Invierno" = "#3498db", "Primavera" = "#2ecc71", 
               "Verano" = "#f39c12", "Otoño" = "#e67e22")
  ) +
  labs(
    title = "Temperatura Media por Año y Estación",
    subtitle = "Arizona 2018-2023",
    x = "Año",
    y = "Temperatura Media (°C)",
    fill = "Estación"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "top",
    panel.grid.minor = element_blank()
  )

print(graf_temp_arizona)
```

#### Islandia:

```{r}
#Grafica de temperatura de Isalandia:
df_temp <- Islandia_temp_json %>%
  spread_all() %>%
  select(fecha, temperatura_media) %>%
  mutate(
    fecha = as.Date(fecha),
    temperatura_media = as.numeric(temperatura_media),
    año = year(fecha),
    mes = month(fecha, label = TRUE, abbr = FALSE),
    mes_num = month(fecha),
    estacion = case_when(
      mes_num %in% c(12, 1, 2) ~ "Invierno",
      mes_num %in% c(3, 4, 5) ~ "Primavera",
      mes_num %in% c(6, 7, 8) ~ "Verano",
      mes_num %in% c(9, 10, 11) ~ "Otoño"
    )
  )

df_resumen <- df_temp %>%
  group_by(año, estacion) %>%
  summarise(
    temp_media = mean(temperatura_media, na.rm = TRUE),
    temp_max = max(temperatura_media, na.rm = TRUE),
    temp_min = min(temperatura_media, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(estacion = factor(estacion, levels = c("Invierno", "Primavera", "Verano", "Otoño")))

graf_temp_islandia <- ggplot(df_resumen, aes(x = as.factor(año), y = temp_media, fill = estacion)) +
  geom_col(position = "dodge", width = 0.7) +
  scale_fill_manual(
    values = c("Invierno" = "#3498db", "Primavera" = "#2ecc71", 
               "Verano" = "#f39c12", "Otoño" = "#e67e22")
  ) +
  labs(
    title = "Temperatura Media por Año y Estación",
    subtitle = "Reykjavik 2018-2023",
    x = "Año",
    y = "Temperatura Media (°C)",
    fill = "Estación"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "top",
    panel.grid.minor = element_blank()
  )

print(graf_temp_islandia)
```

## 2.2. Gráficas combinadas/comparativas

### 2.2.1. Comparación de PIB, suicidios y temperatura.

#### Arizona:

Con este gráfico vamos a ver, para Arizona, cómo evoluciona el PIB per cápita (barras azules, en miles de euros) y la temperatura media anual (línea roja) a lo largo de los años.
Nos permite comparar visualmente si los cambios económicos y los cambios en la temperatura siguen patrones similares o no en el mismo periodo de tiempo.

```{r}
#Graficos de visualizacion con PIB:
ggplot(Arizona_temp_pib_anual, aes(x = Year)) +
  geom_col(aes(y = pib_per_capita / 1000, fill = "PIB per cápita"), alpha = 0.6) +
  geom_line(aes(y = temp_media_anual / 2, color = "Temperatura media anual"), linewidth = 1.1) +
  geom_point(aes(y = temp_media_anual / 2, color = "Temperatura media anual")) +
  scale_y_continuous(
    name = "PIB per cápita (miles de €)",
    sec.axis = sec_axis(~ . * 2, name = "Temperatura media anual (°C)")
  ) +
  scale_fill_manual(name = "", values = c("PIB per cápita" = "steelblue")) +
  scale_color_manual(name = "", values = c("Temperatura media anual" = "red")) +
  labs(
    title = "Arizona: PIB per cápita y temperatura media anual",
    x = "Año"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

#### Islandia:

En este gráfico vamos a observar la evolución del PIB per cápita en Islandia (barras, en miles de euros) junto con la temperatura media anual (línea roja) a lo largo del tiempo. 

```{r}
ggplot(islandia_temp_pib_anual, aes(x = Year)) +
  geom_col(aes(y = pib_per_capita / 1000, fill = "PIB per cápita"), alpha = 0.6) +
  geom_line(aes(y = temp_media / 2, color = "Temperatura media anual"), linewidth = 1.1) +
  geom_point(aes(y = temp_media / 2, color = "Temperatura media anual")) +
  scale_y_continuous(
    name = "PIB per cápita (miles de €)",
    sec.axis = sec_axis(~ . * 2, name = "Temperatura media anual (°C)")
  ) +
  scale_fill_manual(name = "", values = c("PIB per cápita" = "steelblue")) +
  scale_color_manual(name = "", values = c("Temperatura media anual" = "red")) +
  labs(
    title = "Islandia: PIB per cápita y temperatura media anual",
    x = "Año"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

### 2.2.2. Comparación de Suicidios por Grupos de Edad:

Transformamos los datos de suicidios de Arizona e Islandia para agruparlos en cuatro categorías de edad simplificadas: "0-19", "20-39", "40-59" y "60+".
Después, combinamos ambos data frames para generar visualizaciones comparativas.

```{r}
arizona_edad_simpl <- arizona_suicidios %>%
  filter(
    !is.na(Deaths),
    !is.na(Year),
    Age_Group != "Total",
    Year >= 2018, Year <= 2023
  ) %>%
  
  # sacamos el primer número de la categoría de edad
  mutate(
    edad_inicio = as.numeric(str_extract(Age_Group, "\\d+")),
    #clasificamos la edad de inicio en 4 grupos.
    Grupo_edad = case_when(
      edad_inicio < 20 ~ "0-19",
      edad_inicio < 40 ~ "20-39",
      edad_inicio < 60 ~ "40-59",
      TRUE            ~ "60+"
    )
  ) %>%
  #eliminamos filas que no tengan una edad de inicio valida
  filter(!is.na(edad_inicio)) %>%
  group_by(Year, Grupo_edad) %>%
  #calculamos el total de muertes por grupo de edad y año.
  summarise(
    Total_Deaths = sum(Deaths, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Pais = "Arizona")

# Hacemos lo mismo para Islandia.
islandia_edad_simpl <- suicidios_Islandia %>% # Nota: Usamos 'suicidios_Islandia' del paso 1.3.2.
  filter(
    Age != "Total",
    Sex == "Total",
    Year >= 2018, Year <= 2023,
    !is.na(value)
  ) %>%
  #creamos la columna de edad de inicio y grupo de edad.
  mutate(
    edad_inicio = as.numeric(str_extract(Age, "\\d+")),
    Grupo_edad = case_when(
      edad_inicio < 20 ~ "0-19",
      edad_inicio < 40 ~ "20-39",
      edad_inicio < 60 ~ "40-59",
      TRUE            ~ "60+"
    )
  ) %>%
  # eliminamos filas sin edad de inicio valida.
  filter(!is.na(edad_inicio)) %>%
  group_by(Year, Grupo_edad) %>%
  #calculamos el total de muertes por grupo de edad y año.
  summarise(
    Total_Deaths = sum(value, na.rm = TRUE),
    .groups = "drop" # el drop es para evitar mensajes de agrupamiento.
  ) %>%
  mutate(Pais = "Islandia")

# Unimos ambos data frames para la comparación
comparacion_edad_simpl <- bind_rows(arizona_edad_simpl, islandia_edad_simpl) %>%
  mutate(
    Grupo_edad = factor(Grupo_edad,
                        levels = c("0-19", "20-39", "40-59", "60+"))
  )
```

Generamos una animación para visualizar la evolución anual de los suicidios por grupo de edad, facilitando la comprensión de las tendencias.
Sin embargo, debido a la limitada disponibilidad y transparencia de los datos en Estados Unidos, los registros de Arizona solo están disponibles a partir de 2015, mientras que Islandia cuenta con datos desde 1980.
Por esta razón, en la animación aparece el aviso de “No hay datos” para Arizona en los años anteriores a 2015, mientras que Islandia muestra información continua durante todo el periodo.

```{r, eval=FALSE}
library(gganimate)
library(gifski)

# Realizamos la animación con gganimate.
p_anim_edad <- ggplot(
  comparacion_edad_simpl,
  aes(x = Grupo_edad,
      y = Total_Deaths,
      fill = Grupo_edad)
) +
  geom_col(width = 0.7) +
  facet_wrap(~ Pais, scales = "free_y") +   # free_y para que cada país tenga su propia escala y se vea mejor
  labs(
    title = "Suicidios por grupos de edad",
    subtitle = "Año: {closest_state}",
    x = "Grupo de edad",
    y = "Número de suicidios",
    fill = "Grupos de edad"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  ) +
  transition_states(
    Year,
    transition_length = 2,
    state_length = 1
  ) +
  ease_aes("linear")

# Generamos la animacion.
anim_edad <- animate(
  p_anim_edad,
  nframes = 120,
  fps = 6,
  width = 900,
  height = 500,
  renderer = gifski_renderer()
)

anim_edad
# Para guardar la imagen quitar el hastag, pero esque se me guarda cada vez que ejecuto por eso lo comento.
# anim_save("suicidios_grupos_edad_Arizona_Islandia.gif", animation = anim_edad)
```

A partir de los datos simplificados, generamos un gráfico de líneas para comparar la evolución anual de los suicidios por grupo de edad en Arizona e Islandia.

```{r}
# Hacemos el gráfico comparativo de suicidios por grupo de edad en ambos paises.
graf_comp_edad_simpl <- ggplot(
  comparacion_edad_simpl,
  aes(x = Year, y = Total_Deaths,
      color = Grupo_edad, group = Grupo_edad)
) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  facet_wrap(~ Pais, scales = "free_y") +   # escala libre por país
  labs(
    title = "Suicidios por Grandes Grupos de Edad",
    subtitle = "Comparación Arizona vs Islandia (2018–2023)",
    x = "Año",
    y = "Número de suicidios",
    color = "Grupo de edad"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank(),
    legend.position = "bottom"
  )

print(graf_comp_edad_simpl) #grafico de suicidios por grupo de edad en los dos sitios
```

### Analisis de correlacion entre temperatura y suicidios en Arizona e Islandia:

Por último, se explora de forma descriptiva si existe una posible relación lineal entre la temperatura media anual y el número total de suicidios en el periodo 2018–2023.
Para ello se calcula, en cada país, la temperatura media anual y el total de suicidios por año, y se representa un diagrama de dispersión con recta de regresión, junto con el coeficiente de correlación de Pearson.
Por último, se explora de forma descriptiva si existe una posible relación lineal entre la temperatura media anual y el número total de suicidios en el periodo 2018–2023.
Para ello se calcula, en cada país, la temperatura media anual y el total de suicidios por año, y se representa un diagrama de dispersión con recta de regresión, junto con el coeficiente de correlación de Pearson.
#### Arizona:

```{r}
# Suicidios totales por año en Arizona

arizona_suic_anual <- arizona_suicidios %>%
filter(Year >= 2018, Year <= 2023,
!is.na(Deaths)) %>%
group_by(Year) %>%
summarise(
suicidios_totales = sum(Deaths, na.rm = TRUE),
.groups = "drop"
)

# Temperatura media anual en Arizona (a partir de df_temp_arizona creado antes)

arizona_temp_anual <- Arizona_temp_filtrado %>%
  group_by(Year) %>%
  summarise(
    temp_media_anual = mean(Value, na.rm = TRUE),
    .groups = "drop"
  )

# Unimos temperatura y suicidios

arizona_temp_suic <- inner_join(
arizona_temp_anual,
arizona_suic_anual,
by = "Year"
)

arizona_temp_suic

# Diagrama de dispersión con recta de regresión

graf_arizona_temp_suic <- ggplot(arizona_temp_suic,
aes(x = temp_media_anual,
y = suicidios_totales)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE) +
labs(
title = "Arizona: suicidios vs temperatura media anual",
subtitle = "2018–2023",
x = "Temperatura media anual (°F)",
y = "Número de suicidios"
) +
theme_minimal(base_size = 12)

print(graf_arizona_temp_suic)

# Coeficiente de correlación de Pearson

cor_arizona <- cor(
arizona_temp_suic$temp_media_anual,
arizona_temp_suic$suicidios_totales,
use = "complete.obs"
)
cor_arizona
```

En Arizona, el coeficiente de correlación de Pearson entre temperatura media anual y número de suicidios es muy cercano a cero, lo que indica que, con los datos disponibles, **no se observa una relación lineal clara** entre ambas variables.
En Arizona, el coeficiente de correlación de Pearson entre temperatura media anual y número de suicidios es muy cercano a cero, lo que indica que, con los datos disponibles, **no se observa una relación lineal clara** entre ambas variables.
#### Islandia:

```{r}
# Suicidios totales por año en Islandia (usando suicidios_Islandia)

islandia_suic_anual <- suicidios_Islandia %>%
filter(Year >= 2018, Year <= 2023,
Sex == "Total",
!is.na(value)) %>%
group_by(Year) %>%
summarise(
suicidios_totales = sum(value, na.rm = TRUE),
.groups = "drop"
)

# Temperatura media anual en Islandia (a partir de df_temp creado antes)

islandia_temp_anual <- df_temp %>%
group_by(año) %>%
summarise(
temp_media_anual = mean(temperatura_media, na.rm = TRUE),
.groups = "drop"
) %>%
rename(Year = año)

# Unimos temperatura y suicidios

islandia_temp_suic <- inner_join(
islandia_temp_anual,
islandia_suic_anual,
by = "Year"
)

islandia_temp_suic

# Diagrama de dispersión con recta de regresión

graf_islandia_temp_suic <- ggplot(islandia_temp_suic,
aes(x = temp_media_anual,
y = suicidios_totales)) +
geom_point(size = 3) +
geom_smooth(method = "lm", se = FALSE) +
labs(
title = "Islandia: suicidios vs temperatura media anual",
subtitle = "2018–2023",
x = "Temperatura media anual (°C)",
y = "Número de suicidios"
) +
theme_minimal(base_size = 12)

print(graf_islandia_temp_suic)

# Coeficiente de correlación de Pearson

cor_islandia <- cor(
islandia_temp_suic$temp_media_anual,
islandia_temp_suic$suicidios_totales,
use = "complete.obs"
)
cor_islandia
```
